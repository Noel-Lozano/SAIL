<!DOCTYPE html>
<html>
<head>
    <title>Places to Visit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h2>Places to Visit in {{ city }}</h2>
    
    <div class="search-form">
        <form action="/planning" method="get">
            <input type="text" name="city" placeholder="Enter city" value="{{ city }}">
            <input type="text" name="place" placeholder="Enter place (optional)" value="{{ place }}">
            <button type="submit">Search</button>
        </form>
        <a href="/itinerary" class="btn-success">View My Itinerary</a>
    </div>
    
    <div id="map"></div>
    
    <div class="places-list">
        {% for place in places %}
            <div class="place-item" data-place-id="{{ place.place_id }}">
                <div class="place-info">
                    <div class="place-name">{{ place.name }}</div>
                    <div class="place-address">{{ place.address }}</div>
                    {% if place.editorial_summary %}
                        <div class="place-summary">{{ place.editorial_summary }}</div>
                    {% endif %}
                </div>
                <div class="place-actions">
                    <button class="save-btn"
                            data-place='{{ {
                                "id": place.place_id,
                                "name": place.name,
                                "address": place.address,
                                "city": city,
                                "latitude": place.location.lat,
                                "longitude": place.location.lng,
                                "editorial_summary": place.editorial_summary
                            } | tojson }}'
                            onclick="savePlace(this)"
                            title="Save place">‚≠ê</button>
                    <a href="https://www.google.com/maps/search/?api=1&query={{ place.location.lat }},{{ place.location.lng }}" 
                       target="_blank" 
                       class="maps-link"
                       title="Open in Google Maps">Maps</a>
                    <button class="view-on-map-btn" 
                            onclick="focusOnMarker('{{ place.place_id }}')"
                            title="View on map">üìç</button>
                </div>
            </div>
        {% endfor %}
    </div>

    <script>
        let map;
        let markers = {};
        let infoWindows = {};

        function savePlace(buttonElement) {
            const place = JSON.parse(buttonElement.dataset.place);

            buttonElement.disabled = true;
            buttonElement.style.opacity = '0.5';

            fetch('/save_place', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(place)
            })
            .then(res => res.json())
            .then(data => {
                if (data.message) {
                    buttonElement.classList.add('saved');
                    buttonElement.title = 'Place saved!';
                    const original = buttonElement.innerHTML;
                    buttonElement.innerHTML = '‚úÖ';
                    setTimeout(() => {
                        buttonElement.innerHTML = original;
                    }, 1000);
                } else {
                    alert(data.error || 'Error saving place');
                }
            })
            .catch(err => {
                console.error('Error saving place:', err);
                alert('Error saving place');
            })
            .finally(() => {
                buttonElement.disabled = false;
                buttonElement.style.opacity = '1';
            });
        }

        function focusOnMarker(placeId) {
            const marker = markers[placeId];
            if (marker) {
                map.setCenter(marker.getPosition());
                map.setZoom(16);
                
                const infoWindow = infoWindows[placeId];
                if (infoWindow) {
                    Object.values(infoWindows).forEach(iw => iw.close());
                    infoWindow.open(map, marker);
                }
                
                document.querySelectorAll('.place-item').forEach(item => {
                    item.classList.remove('highlighted');
                });
                const placeItem = document.querySelector(`[data-place-id="${placeId}"]`);
                if (placeItem) {
                    placeItem.classList.add('highlighted');
                    placeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(() => {
                    marker.setAnimation(null);
                }, 2000);
            }
        }

        function createInfoWindowContent(place) {
            const summary = place.editorial_summary || 'No description available';
            const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${place.location.lat},${place.location.lng}`;
            
            return `
                <div class="custom-info-window">
                    <div class="info-title">${place.name}</div>
                    <div class="info-address">${place.address}</div>
                    <div class="info-summary">${summary}</div>
                    <div class="info-actions">
                        <a href="${mapsUrl}" target="_blank" class="info-maps-link">Open in Maps</a>
                        <button class="info-save-btn" onclick="savePlace(this)" 
                                data-place='${JSON.stringify(place)}'>Save Place</button>
                    </div>
                </div>
            `;
        }

        const locationsData = {{ places | tojson | safe }};

        function initMap() {
            const mapElement = document.getElementById("map");
            
            map = new google.maps.Map(mapElement, { 
                zoom: 12, 
                gestureHandling: 'greedy' 
            });
            
            const bounds = new google.maps.LatLngBounds();
            const locations = locationsData;
            
            locations.forEach(loc => {
                if (loc && loc.location) {
                    const marker = new google.maps.Marker({
                        position: { lat: loc.location.lat, lng: loc.location.lng },
                        map: map,
                        title: loc.name,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="30" height="40" viewBox="0 0 30 40" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M15 0C6.7 0 0 6.7 0 15c0 11.25 15 25 15 25s15-13.75 15-25C30 6.7 23.3 0 15 0z" fill="#EA4335"/>
                                    <circle cx="15" cy="15" r="8" fill="white"/>
                                    <text x="15" y="20" text-anchor="middle" font-size="14" fill="#EA4335">üìç</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(30, 40),
                            anchor: new google.maps.Point(15, 40)
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: createInfoWindowContent(loc)
                    });

                    marker.addListener("click", () => {
                        Object.values(infoWindows).forEach(iw => iw.close());
                        infoWindow.open(map, marker);
                        
                        document.querySelectorAll('.place-item').forEach(item => {
                            item.classList.remove('highlighted');
                        });
                        const placeItem = document.querySelector(`[data-place-id="${loc.place_id}"]`);
                        if (placeItem) {
                            placeItem.classList.add('highlighted');
                            placeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });

                    markers[loc.place_id] = marker;
                    infoWindows[loc.place_id] = infoWindow;

                    bounds.extend(marker.getPosition());
                }
            });

            if (locations.length > 0) {
                map.fitBounds(bounds);
                if (locations.length === 1) {
                    map.setZoom(15);
                }
            } else {
                map.setCenter({lat: 40.7128, lng: -74.0060});
                map.setZoom(12);
            }
        }
        
        window.addEventListener('load', function() {
            if (typeof google !== 'undefined' && google.maps) {
                initMap();
            }
        });
    </script>
    <script async src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
</body>
</html>